image: maven:3.9.6-eclipse-temurin-17-alpine

stages:
  - build
  - test
  - packing
  - deploy
  - post_deploy 

variables:
  MAVEN_OPTS: "-Dmaven.test.failure.ignore=false"

# 1) Build: compilar el proyecto
build:
  stage: build
  script:
    - echo "Compilando proyecto con Maven"
    - mvn -B clean compile
  artifacts:
    paths:
      - target/

# 2) Test: ejecutar pruebas unitarias
test:
  stage: test
  script:
    - echo "Ejecutando pruebas unitarias"
    - mvn -B test
  artifacts:
    paths:
      - target/

# 3) Packing: empaquetar el JAR
packing:
  stage: packing
  script:
    - echo "Empaquetando con Maven (sin tests)"
    - mvn -B package -DskipTests
    - echo "Mostrando contenido de target/"
    - ls -l target
  artifacts:
    paths:
      - target/to-do-list-api-0.0.1-SNAPSHOT.jar

# 4) Simulación Deploy: mover el JAR a una carpeta de 'deploy'
deploy:
  stage: deploy
  script:
    - echo "Simulando deploy de la aplicación"
    - mkdir -p deploy
    - cp target/to-do-list-api-0.0.1-SNAPSHOT.jar deploy/api.jar
    - echo "Contenido de la carpeta deploy/"
    - ls -l deploy
  dependencies:
    - packing
  artifacts:
    paths:
      - deploy/api.jar

# 5) API Test: ejecutar el jar y probar el CRUD
api_test:
  stage: post_deploy
  script:
    - echo "Iniciando API para pruebas"
    - java -jar deploy/api.jar &
    - echo "Esperando que la API arranque..."
    - sleep 12

    - echo "Probando INSERT (POST)"
    - >
      curl -X POST http://localhost:8080/api/tasks
      -H "Content-Type: application/json"
      -d '{"title":"Test desde CI","description":"insertado por CI/CD","completed":false}' 
      -o post_output.txt -w "%{http_code}" > http_status_post.txt

    - echo "Código HTTP POST:"
    - cat http_status_post.txt
    - |
      STATUS=$(cat http_status_post.txt)
      if [ "$STATUS" = "200" ] || [ "$STATUS" = "201" ]; then
        echo "POST OK con código $STATUS"
      else
        echo "POST falló con código $STATUS"
        exit 1
      fi

    - echo "Probando LISTADO (GET)"
    - curl -s http://localhost:8080/api/tasks > get_output.json
    - cat get_output.json
    - 'grep -q "Test desde CI" get_output.json || (echo "GET no contiene la tarea insertada" && exit 1)'

  dependencies:
    - deploy
  artifacts:
    paths:
      - post_output.txt
      - get_output.json


# 6) Post-deploy: verificación simulada
post_deploy:
  stage: post_deploy
  script:
    - echo "Verificando deploy simulado..."
    - |
      if [ -f deploy/api.jar ]; then
        echo "OK: api.jar existe en deploy/"
      else
        echo "ERROR: api.jar no encontrado en deploy/"
        exit 1
      fi
    - echo "Pipeline completo build + test + package + deploy simulado + verificación"
  dependencies:
    - deploy

